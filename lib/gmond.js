// Generated by CoffeeScript 1.4.0
(function() {
  var CLI, Config, Gmetric, Gmond, Logger, WebServer, builder, net,
    __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  Gmetric = require('gmetric');

  net = require('net');

  builder = require('xmlbuilder');

  Logger = require('./logger');

  CLI = require('./cli');

  Config = require('./config');

  WebServer = require('./webserver');

  /**
   * The ganglia gmond class.
  */


  Gmond = (function() {

    function Gmond() {
      this.generate_cluster_element = __bind(this.generate_cluster_element, this);
      this.generate_xml_snapshot = __bind(this.generate_xml_snapshot, this);
      this.determine_cluster_from_metric = __bind(this.determine_cluster_from_metric, this);
      this.merge_metric = __bind(this.merge_metric, this);
      this.add_metric = __bind(this.add_metric, this);
      this.stop_xml_service = __bind(this.stop_xml_service, this);
      this.start_xml_service = __bind(this.start_xml_service, this);      this.config = Config.get();
      this.logger = Logger.get();
      this.gmetric = new Gmetric();
      this.gmond_started = this.unix_time();
      this.host_timers = new Object();
      this.hosts = new Object();
      this.clusters = new Object();
      this.udp_server = null;
      this.xml_server = null;
      this.start_xml_service();
    }

    /**
     * Starts up the xml service.
    */


    Gmond.prototype.start_xml_service = function() {
      var _this = this;
      this.xml_server = net.createServer(function(sock) {
        return sock.end(_this.generate_xml_snapshot());
      });
      return this.xml_server.listen(this.config.get('gmond_tcp_port'), this.config.get('listen_address'));
    };

    /**
     * Stops the xml service.
     * @param {Function} (fn) The callback function
    */


    Gmond.prototype.stop_xml_service = function(fn) {
      return this.xml_server.close(fn);
    };

    /**
     * Returns the current unix timestamp.
     * @return {Integer} The unix timestamp integer
    */


    Gmond.prototype.unix_time = function() {
      return new Date().getTime();
    };

    /**
     * Adds a new metric automatically determining the cluster or using defaults.
     * @param {Object} (metric)
    */


    Gmond.prototype.add_metric = function(metric) {
      var cluster, hmet, msg_type, _base, _base1, _base2, _name;
      msg_type = metric.readInt32BE(0);
      hmet = this.gmetric.unpack(metric);
      (_base = this.hosts)[_name = hmet.hostname] || (_base[_name] = new Object());
      if (msg_type === 128) {
        cluster = this.determine_cluster_from_metric(hmet);
        (_base1 = this.hosts[hmet.hostname]).cluster || (_base1.cluster = cluster);
        (_base2 = this.clusters)[cluster] || (_base2[cluster] = new Object());
        this.clusters[cluster][hmet.hostname] = true;
      }
      return this.merge_metric(this.hosts[hmet.hostname], hmet);
    };

    /**
     * Merges a metric with the hosts object.
     * @param {Object} (target) The target hosts object to modify
     * @param {Object} (gmetric) The host information to merge
    */


    Gmond.prototype.merge_metric = function(target, hmetric) {
      var key, now, _base, _i, _len, _name, _ref;
      now = this.unix_time();
      target['host_reported'] = now;
      target['info'] || (target['info'] = new Object());
      target['reported'] || (target['reported'] = new Object());
      target['tags'] || (target['tags'] = new Array());
      target['ip'] || (target['ip'] = hmetric.hostname);
      target['metrics'] || (target['metrics'] = new Object());
      (_base = target['metrics'])[_name = hmetric.name] || (_base[_name] = new Object());
      _ref = Object.keys(hmetric);
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        key = _ref[_i];
        target['metrics'][hmetric.name][key] = hmetric[key];
      }
      return target['reported'][hmetric.name] = now;
    };

    /**
     * Returns the cluster of the metric or assumes the default.
     * @param {H}
    */


    Gmond.prototype.determine_cluster_from_metric = function(hmetric) {
      var cluster;
      cluster = hmetric['cluster'];
      if (cluster === void 0) {
        cluster = this.config.get('cluster');
      }
      delete hmetric['cluster'];
      return cluster;
    };

    /**
     * Generates an xml snapshot of the gmond state.
    */


    Gmond.prototype.generate_xml_snapshot = function() {
      var cluster, root, _i, _len, _ref;
      root = this.get_gmond_xml_root();
      _ref = Object.keys(this.clusters);
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        cluster = _ref[_i];
        root = generate_cluster_element(root, cluster);
      }
      return root.end({
        pretty: true,
        indent: '  ',
        newline: "\n"
      });
    };

    /**
     * Appends the cluster_xml for a single cluster to the
    */


    Gmond.prototype.generate_cluster_element = function(root, cluster) {
      var ce, h, hostlist, _i, _len;
      if (Object.keys(this.clusters[cluster].hosts).length === 0) {
        delete_cluster(cluster);
      }
      ce = root.ele('CLUSTER');
      ce.att('NAME', this.clusters[cluster].name || this.config.get('cluster'));
      ce.att('LOCALTIME', new Date().getTime());
      ce.att('OWNER', this.clusters[cluster].owner || this.config.get('owner'));
      ce.att('LATLONG', this.clusters[cluster].latlong || this.config.get('latlong'));
      ce.att('URL', this.clusters[cluster].url || this.config.get('url'));
      if (this.clusters[cluster].hosts === void 0) {
        return root;
      }
      hostlist = Object.keys(this.clusters[cluster].hosts);
      if (hostlist.length === 0) {
        return root;
      }
      for (_i = 0, _len = hostlist.length; _i < _len; _i++) {
        h = hostlist[_i];
        ce = generate_host_element(ce, this.clusters[cluster]['hosts'][h], h);
      }
      return root;
    };

    /**
     * Generates a host element for a given host and attaches to the parent.
    */


    Gmond.prototype.generate_host_element = function(parent, host, hostname) {
      var he, m, _i, _len, _ref;
      he = parent.ele('HOST');
      he.att('NAME', hostname);
      he.att('IP', host['ip']);
      he.att('TAGS', (host['tags'] || []).join(','));
      he.att('REPORTED', host['host_reported']);
      he.att('TN', this.unix_time() - host['host_reported']);
      he.att('TMAX', host.tmax || this.config.get('tmax'));
      he.att('DMAX', host.dmax || this.config.get('dmax'));
      he.att('LOCATION', host.location || this.config.get('latlong'));
      he.att('GMOND_STARTED', this.gmond_started);
      _ref = Object.keys(host.metrics);
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        m = _ref[_i];
        he = this.generate_metric_element(he, host, host.metrics[m]);
      }
      return parent;
    };

    /**
     * Generates the metric element and attaches to the parent.
    */


    Gmond.prototype.generate_metric_element = function(parent, host, metric) {
      var me;
      me = parent.ele('METRIC');
      me.att('NAME', metric.name);
      me.att('VAL', metric.value);
      me.att('TYPE', metric.type);
      me.att('UNITS', metric.units);
      me.att('TN', this.unix_time() - host['reported'][metric.name]);
      me.att('TMAX', metric.tmax || this.config.get('tmax'));
      me.att('DMAX', metric.dmax || this.config.get('dmax'));
      me.att('SLOPE', metric.slope);
      me = this.generate_extra_elements(me, metric);
      return parent;
    };

    /**
     * Generates the extra elems for a metric and attaches to the parent.
    */


    Gmond.prototype.generate_extra_elements = function(parent, metric) {
      var ed, ee, extra, extras, _i, _len;
      extras = this.gmetric.extra_elements(metric);
      if (extras.length < 1) {
        return parent;
      }
      ed = parent.ele('EXTRA_DATA');
      for (_i = 0, _len = extras.length; _i < _len; _i++) {
        extra = extras[_i];
        ee = ed.ele('EXTRA_ELEMENT');
        ee.att('NAME', extra);
        ee.att('VAL', metric[extra]);
      }
      return parent;
    };

    /**
     * Returns the gmond_xml root node to build upon.
     * @return {Object} The root gmond xmlbuilder
    */


    Gmond.prototype.get_gmond_xml_root = function() {
      var root;
      root = builder.create('GANGLIA_XML', {
        version: '1.0',
        encoding: 'ISO-8859-1',
        standalone: 'yes'
      }, {
        ext: "[\n<!ELEMENT GANGLIA_XML (GRID|CLUSTER|HOST)*>\n  <!ATTLIST GANGLIA_XML VERSION CDATA #REQUIRED>\n  <!ATTLIST GANGLIA_XML SOURCE CDATA #REQUIRED>\n<!ELEMENT GRID (CLUSTER | GRID | HOSTS | METRICS)*>\n  <!ATTLIST GRID NAME CDATA #REQUIRED>\n  <!ATTLIST GRID AUTHORITY CDATA #REQUIRED>\n  <!ATTLIST GRID LOCALTIME CDATA #IMPLIED>\n<!ELEMENT CLUSTER (HOST | HOSTS | METRICS)*>\n  <!ATTLIST CLUSTER NAME CDATA #REQUIRED>\n  <!ATTLIST CLUSTER OWNER CDATA #IMPLIED>\n  <!ATTLIST CLUSTER LATLONG CDATA #IMPLIED>\n  <!ATTLIST CLUSTER URL CDATA #IMPLIED>\n  <!ATTLIST CLUSTER LOCALTIME CDATA #REQUIRED>\n<!ELEMENT HOST (METRIC)*>\n  <!ATTLIST HOST NAME CDATA #REQUIRED>\n  <!ATTLIST HOST IP CDATA #REQUIRED>\n  <!ATTLIST HOST LOCATION CDATA #IMPLIED>\n  <!ATTLIST HOST TAGS CDATA #IMPLIED>\n  <!ATTLIST HOST REPORTED CDATA #REQUIRED>\n  <!ATTLIST HOST TN CDATA #IMPLIED>\n  <!ATTLIST HOST TMAX CDATA #IMPLIED>\n  <!ATTLIST HOST DMAX CDATA #IMPLIED>\n  <!ATTLIST HOST GMOND_STARTED CDATA #IMPLIED>\n<!ELEMENT METRIC (EXTRA_DATA*)>\n  <!ATTLIST METRIC NAME CDATA #REQUIRED>\n  <!ATTLIST METRIC VAL CDATA #REQUIRED>\n  <!ATTLIST METRIC TYPE (string | int8 | uint8 | int16 | uint16 | int32 | uint32 | int64 | uint64 | float | double | timestamp) #REQUIRED>\n  <!ATTLIST METRIC UNITS CDATA #IMPLIED>\n  <!ATTLIST METRIC TN CDATA #IMPLIED>\n  <!ATTLIST METRIC TMAX CDATA #IMPLIED>\n  <!ATTLIST METRIC DMAX CDATA #IMPLIED>\n  <!ATTLIST METRIC SLOPE (zero | positive | negative | both | unspecified) #IMPLIED>\n  <!ATTLIST METRIC SOURCE (gmond) 'gmond'>\n<!ELEMENT EXTRA_DATA (EXTRA_ELEMENT*)>\n<!ELEMENT EXTRA_ELEMENT EMPTY>\n  <!ATTLIST EXTRA_ELEMENT NAME CDATA #REQUIRED>\n  <!ATTLIST EXTRA_ELEMENT VAL CDATA #REQUIRED>\n<!ELEMENT HOSTS EMPTY>\n  <!ATTLIST HOSTS UP CDATA #REQUIRED>\n  <!ATTLIST HOSTS DOWN CDATA #REQUIRED>\n  <!ATTLIST HOSTS SOURCE (gmond | gmetad) #REQUIRED>\n<!ELEMENT METRICS (EXTRA_DATA*)>\n  <!ATTLIST METRICS NAME CDATA #REQUIRED>\n  <!ATTLIST METRICS SUM CDATA #REQUIRED>\n  <!ATTLIST METRICS NUM CDATA #REQUIRED>\n  <!ATTLIST METRICS TYPE (string | int8 | uint8 | int16 | uint16 | int32 | uint32 | int64 | uint64 | float | double | timestamp) #REQUIRED>\n  <!ATTLIST METRICS UNITS CDATA #IMPLIED>\n  <!ATTLIST METRICS SLOPE (zero | positive | negative | both | unspecified) #IMPLIED>\n  <!ATTLIST METRICS SOURCE (gmond) 'gmond'>\n<GANGLIA_XML VERSION=\"3.3.0\" SOURCE=\"gmond\">\n]"
      });
      return root;
    };

    return Gmond;

  })();

  module.exports = Gmond;

}).call(this);

// Generated by CoffeeScript 1.4.0
(function() {
  var CLI, Config, Gmetric, Gmond, Logger, WebServer, builder, net,
    __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  Gmetric = require('gmetric');

  net = require('net');

  builder = require('xmlbuilder');

  Logger = require('./logger');

  CLI = require('./cli');

  Config = require('./config');

  WebServer = require('./webserver');

  /**
   * The ganglia gmond class.
  */


  Gmond = (function() {

    function Gmond() {
      this.generate_cluster_xml = __bind(this.generate_cluster_xml, this);

      this.generate_xml_snapshot = __bind(this.generate_xml_snapshot, this);

      this.determine_cluster_from_metric = __bind(this.determine_cluster_from_metric, this);

      this.add_metric = __bind(this.add_metric, this);

      this.start_xml_service = __bind(this.start_xml_service, this);
      this.config = Config.get();
      this.logger = Logger.get();
      this.start_xml_service();
      this.clusters = {
        analytics: {
          owner: null,
          latlong: null,
          url: null,
          hosts: new Object()
        }
      };
      console.log(this.clusters);
    }

    /**
     * Starts up the xml service.
    */


    Gmond.prototype.start_xml_service = function() {
      var server,
        _this = this;
      this.logger.info('Starting xml service');
      server = net.createServer(function(sock) {
        return sock.end(_this.generate_xml_snapshot());
      });
      return server.listen(this.config.get('gmond_tcp_port'), this.config.get('listen_address'));
    };

    /**
     * Adds a new metric automatically determining the cluster or using defaults.
    */


    Gmond.prototype.add_metric = function(metric) {
      var cluster, hmet, _base, _name;
      hmet = hashify_metric(metric);
      cluster = this.determine_cluster_from_metric(hmet);
      return (_base = this.clusters)[_name = hmet.cluster] || (_base[_name] = new Object());
    };

    Gmond.prototype.determine_cluster_from_metric = function(metric) {
      return "analytics";
    };

    Gmond.prototype.hashify_metric = function(metric) {
      var hmet;
      hmet = new Object();
    };

    /**
     * Generates an xml snapshot of the gmond state.
    */


    Gmond.prototype.generate_xml_snapshot = function() {
      var cluster, root, _i, _len, _ref, _results;
      root = this.get_gmond_xml_root();
      _ref = Object.keys(this.clusters);
      _results = [];
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        cluster = _ref[_i];
        _results.push(generate_cluster_xml(root, cluster));
      }
      return _results;
    };

    /**
     * Appends the cluster_xml for a single cluster to the
    */


    Gmond.prototype.generate_cluster_xml = function(root, cluster) {
      var c_ele;
      if (Object.keys(this.clusters[cluster]['hosts']) === 0) {
        delete_cluster(cluster);
      }
      c_ele = root.ele('CLUSTER');
      c_ele.att('NAME', this.clusters[cluster]['name']);
      c_ele.att('LOCALTIME', new Date().getTime());
      c_ele.att('LATLONG', this.clusters[cluster]['latlong'] || "unspecified");
      return c_ele.att('URL', this.clusters[cluster]['url'] || "127.0.0.1");
    };

    Gmond.prototype.generate_metric = function() {};

    Gmond.prototype.generate_extra_element = function() {};

    /**
     * Returns the gmond_xml root node to build upon.
     * @return {Object} The root gmond xmlbuilder
    */


    Gmond.prototype.get_gmond_xml_root = function() {
      var root;
      root = builder.create('GANGLIA_XML', {
        version: '1.0',
        encoding: 'ISO-8859-1',
        standalone: 'yes'
      }, {
        ext: "[\n<!ELEMENT GANGLIA_XML (GRID|CLUSTER|HOST)*>\n  <!ATTLIST GANGLIA_XML VERSION CDATA #REQUIRED>\n  <!ATTLIST GANGLIA_XML SOURCE CDATA #REQUIRED>\n<!ELEMENT GRID (CLUSTER | GRID | HOSTS | METRICS)*>\n  <!ATTLIST GRID NAME CDATA #REQUIRED>\n  <!ATTLIST GRID AUTHORITY CDATA #REQUIRED>\n  <!ATTLIST GRID LOCALTIME CDATA #IMPLIED>\n<!ELEMENT CLUSTER (HOST | HOSTS | METRICS)*>\n  <!ATTLIST CLUSTER NAME CDATA #REQUIRED>\n  <!ATTLIST CLUSTER OWNER CDATA #IMPLIED>\n  <!ATTLIST CLUSTER LATLONG CDATA #IMPLIED>\n  <!ATTLIST CLUSTER URL CDATA #IMPLIED>\n  <!ATTLIST CLUSTER LOCALTIME CDATA #REQUIRED>\n<!ELEMENT HOST (METRIC)*>\n  <!ATTLIST HOST NAME CDATA #REQUIRED>\n  <!ATTLIST HOST IP CDATA #REQUIRED>\n  <!ATTLIST HOST LOCATION CDATA #IMPLIED>\n  <!ATTLIST HOST TAGS CDATA #IMPLIED>\n  <!ATTLIST HOST REPORTED CDATA #REQUIRED>\n  <!ATTLIST HOST TN CDATA #IMPLIED>\n  <!ATTLIST HOST TMAX CDATA #IMPLIED>\n  <!ATTLIST HOST DMAX CDATA #IMPLIED>\n  <!ATTLIST HOST GMOND_STARTED CDATA #IMPLIED>\n<!ELEMENT METRIC (EXTRA_DATA*)>\n  <!ATTLIST METRIC NAME CDATA #REQUIRED>\n  <!ATTLIST METRIC VAL CDATA #REQUIRED>\n  <!ATTLIST METRIC TYPE (string | int8 | uint8 | int16 | uint16 | int32 | uint32 | int64 | uint64 | float | double | timestamp) #REQUIRED>\n  <!ATTLIST METRIC UNITS CDATA #IMPLIED>\n  <!ATTLIST METRIC TN CDATA #IMPLIED>\n  <!ATTLIST METRIC TMAX CDATA #IMPLIED>\n  <!ATTLIST METRIC DMAX CDATA #IMPLIED>\n  <!ATTLIST METRIC SLOPE (zero | positive | negative | both | unspecified) #IMPLIED>\n  <!ATTLIST METRIC SOURCE (gmond) 'gmond'>\n<!ELEMENT EXTRA_DATA (EXTRA_ELEMENT*)>\n<!ELEMENT EXTRA_ELEMENT EMPTY>\n  <!ATTLIST EXTRA_ELEMENT NAME CDATA #REQUIRED>\n  <!ATTLIST EXTRA_ELEMENT VAL CDATA #REQUIRED>\n<!ELEMENT HOSTS EMPTY>\n  <!ATTLIST HOSTS UP CDATA #REQUIRED>\n  <!ATTLIST HOSTS DOWN CDATA #REQUIRED>\n  <!ATTLIST HOSTS SOURCE (gmond | gmetad) #REQUIRED>\n<!ELEMENT METRICS (EXTRA_DATA*)>\n  <!ATTLIST METRICS NAME CDATA #REQUIRED>\n  <!ATTLIST METRICS SUM CDATA #REQUIRED>\n  <!ATTLIST METRICS NUM CDATA #REQUIRED>\n  <!ATTLIST METRICS TYPE (string | int8 | uint8 | int16 | uint16 | int32 | uint32 | int64 | uint64 | float | double | timestamp) #REQUIRED>\n  <!ATTLIST METRICS UNITS CDATA #IMPLIED>\n  <!ATTLIST METRICS SLOPE (zero | positive | negative | both | unspecified) #IMPLIED>\n  <!ATTLIST METRICS SOURCE (gmond) 'gmond'>\n<GANGLIA_XML VERSION=\"3.3.0\" SOURCE=\"gmond\">\n]"
      });
      return root;
    };

    return Gmond;

  })();

  module.exports = Gmond;

}).call(this);
